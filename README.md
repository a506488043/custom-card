# 网站卡片插件

## 插件介绍

网站卡片插件是一个功能强大的WordPress插件，可以根据URL自动生成美观的网站卡片，支持缩略图、标题和描述的自动获取与展示。插件采用多级缓存机制，大幅提升访问速度和降低服务器负载。

**版本：** 5.4.0  
**兼容性：** WordPress 5.0 及以上版本  
**测试版本：** WordPress 6.7.1

## 主要功能

- **自动获取网站信息**：根据URL自动抓取网站标题、描述和图片
- **多级缓存支持**：集成Opcache和Memcached缓存，显著提升性能
- **区块编辑器支持**：完全兼容Gutenberg编辑器
- **短代码支持**：通过简单短代码在任何位置插入卡片
- **安全增强**：全面的安全措施防止XSS、SQL注入和SSRF攻击
- **缓存管理界面**：直观的后台管理界面，支持查看和管理缓存项
- **缓存卡片编辑**：支持直接编辑缓存的卡片数据
- **全宽自适应设计**：完美适配WordPress后台页面宽度和各种设备屏幕尺寸
- **访客缓存支持**：未登录用户访问时也能正常显示卡片并写入缓存

## 安装方法

1. 下载插件压缩包
2. 在WordPress后台点击"插件" > "安装插件" > "上传插件"
3. 选择下载的压缩包并点击"现在安装"
4. 安装完成后点击"启用插件"

## 使用方法

### 短代码使用

在文章或页面中使用以下短代码：

```
[custom_card url="https://example.com"]
```

### 区块编辑器使用

1. 在区块编辑器中点击添加区块按钮
2. 搜索"网站卡片"并选择
3. 在区块设置中输入目标URL
4. 保存并预览效果

## 多级缓存机制

插件采用三层缓存机制，显著提升性能：

1. **Opcache缓存**（第一级）：
   - 使用PHP文件存储缓存数据，通过Opcache加速访问
   - 读取速度极快，接近内存操作
   - 自动利用PHP的字节码缓存机制

2. **Memcached缓存**（第二级）：
   - 内存级缓存，访问速度极快
   - 支持分布式部署，可跨服务器共享缓存
   - 自动同步与Opcache缓存

3. **数据库缓存**（第三级）：
   - 将抓取的网站信息存储在数据库中
   - 默认缓存时间为72小时
   - 作为最后的回源机制

### 缓存工作流程

1. 用户访问包含卡片的页面时，插件首先检查Opcache
2. 如果Opcache未命中，则检查Memcached
3. 如果Memcached未命中，则查询数据库缓存
4. 如果数据库缓存未命中或已过期，则从目标网站获取新数据
5. 获取新数据后，同时更新三级缓存

## 后台管理功能

### 优化的管理界面

WordPress后台的"网站卡片"菜单提供了全新的管理界面：

- **优先显示卡片列表**：已缓存的网站卡片列表显示在最上方，方便直接管理
- **全宽卡片列表**：卡片列表占据整个页面宽度，无右侧空白
- **辅助信息次要展示**：缓存状态和使用说明并排显示在第二行
- **响应式设计**：完美适配WordPress后台页面宽度和各种设备屏幕尺寸
- **自适应表格**：缓存卡片列表宽度自动适应浏览器窗口大小变化
- **直观的状态指示**：使用颜色区分有效和过期的缓存项

### 缓存卡片列表

管理界面首行提供完整的缓存卡片列表，包含以下信息：

- ID：缓存项序号
- URL：原始网站地址
- 标题：抓取的网站标题
- 图片：网站缩略图预览
- 过期时间：缓存失效时间（绿色表示有效，红色表示已过期）
- 操作：支持编辑和删除功能

### 缓存状态查看

在管理界面第二行左侧可以查看：

- Memcached缓存状态（启用/禁用）
- Opcache缓存状态（启用/禁用）
- 缓存项总数统计
- 清理所有缓存的按钮

### 使用说明

在管理界面第二行右侧提供简明的使用说明：

- 多级缓存机制介绍
- 短代码使用方法
- 区块编辑器使用提示
- 卡片编辑功能说明

### 卡片编辑功能

新版本增加了卡片数据编辑功能：

1. 点击卡片列表中的"编辑"按钮
2. 在弹出的模态窗口中修改标题、图片URL和描述
3. 图片URL变更时会实时预览
4. 点击"保存更改"按钮提交修改
5. 修改成功后会自动更新列表中的显示

### 缓存管理操作

- **清理所有缓存**：一键清空所有级别的缓存数据
- **编辑单个缓存**：修改特定URL的缓存数据
- **删除单个缓存**：针对特定URL删除缓存项
- **分页浏览**：支持大量缓存项的分页查看

## 安全特性

- 严格的URL验证，防止SSRF攻击
- 完整的数据清洗和转义，防止XSS攻击
- 参数化查询，防止SQL注入
- 请求频率限制，防止滥用
- 安全的缓存存储机制
- 管理操作的权限验证

## 性能优化

- 减少高达90%的数据库查询
- 显著降低服务器负载
- 提高页面加载速度
- 优化外部请求处理
- 限制重定向次数和请求超时时间
- 响应式设计减少资源加载

## 常见问题

### 为什么我的卡片没有显示图片？

可能的原因：
- 目标网站没有提供图片元数据（og:image 或类似标签）
- 图片URL无效或无法访问
- 您在设置中禁用了图片显示

### 如何清除卡片缓存？

您可以在"缓存状态"页面中点击"清理所有缓存"按钮，或者在卡片列表中删除特定的缓存项。

### 如何自定义卡片样式？

您可以在主题的 style.css 文件中添加自定义CSS来覆盖默认样式。主要的CSS类包括：
- `.strict-card` - 卡片容器
- `.strict-inner` - 卡片内部容器
- `.strict-media` - 图片容器
- `.strict-content` - 内容容器
- `.strict-title` - 标题
- `.strict-desc` - 描述

### 如何确认缓存是否生效？

1. 在WordPress后台的"网站卡片"菜单中查看缓存状态
2. 首次访问包含卡片的页面时，加载可能稍慢
3. 再次访问同一页面时，应该明显更快
4. 查看缓存卡片列表中是否有对应URL的记录

### 为什么Opcache缓存使用PHP文件格式？

Opcache缓存使用PHP文件格式有以下优势：

- 直接利用PHP的include机制，执行效率极高
- PHP文件被Opcache缓存后，读取速度接近内存操作
- 避免了序列化/反序列化的开销
- 文件内容是预编译的PHP数组，可直接返回

### 如何编辑缓存的卡片数据？

1. 在WordPress后台进入"网站卡片"菜单
2. 在页面顶部的缓存卡片列表中找到需要编辑的项
3. 点击"编辑"按钮打开编辑窗口
4. 修改标题、图片URL或描述
5. 点击"保存更改"按钮提交修改

### 如何手动清理缓存？

在WordPress后台的"网站卡片"菜单中点击"清理所有缓存"按钮，或者针对特定URL点击列表中的"删除"按钮。

### 为什么我的设备上表格显示不完整？

插件使用了响应式设计，在小屏幕设备上会自动调整表格布局：

- 在桌面设备上显示为标准表格，占据整个页面宽度
- 在移动设备上转换为卡片式布局
- 所有数据都会保留，只是展示方式不同

### 未登录用户能否看到网站卡片？

是的，插件支持未登录用户查看网站卡片，并且访问数据会自动写入缓存系统。

## 更新日志

### 5.4.0
- 恢复短代码功能：支持 `[custom_card url="https://example.com"]` 语法
- 增加WordPress后台设置（二级目录）：卡片列表、插件设置、缓存状态和使用帮助
- 添加缓存时间设置功能：可自定义缓存过期时间
- 为网站卡片列表添加搜索功能：支持按URL、标题或描述搜索
- 优化管理界面布局：所有设置页面使用左右布局，提升用户体验
- 改进短代码显示：确保长短代码在帮助页面中正确显示，不会超出容器

### 5.3.3 
- 菜单栏重新设置

### 5.3.2 (无限流版本)
- 彻底取消了所有限流检查，确保不会因为访问频率而阻止卡片加载
- 确保所有URL都写入数据库和缓存，无论元数据获取成功与否
- 优化异常处理流程，捕获所有可能的异常，并确保即使出错也能写入数据库
- 添加详细的错误日志记录，便于后续排查问题
- 解决文章首次访问卡顿问题，显著提升页面加载速度

### 5.3.1 (懒加载版本)
- 优化网站卡片加载机制，实现懒加载功能
- 卡片仅在滚动到可视区域时才加载，提升页面首次加载性能
- 减轻服务器压力，优化资源利用
- 保持原有卡片样式和外观不变

### 5.2.5
- 修复未登录用户无法显示网站卡片的问题
- 优化前端AJAX请求处理机制
- 确保访客访问时也能正常写入缓存和数据库

### 5.2.4
- 调整管理界面布局顺序，将已缓存的网站卡片列表移至第一行
- 将缓存状态和使用说明并排显示在第二行
- 优化整体视觉层次，突出重点内容
- 改进响应式布局，确保在各种屏幕尺寸下都能完整显示

### 5.2.3
- 优化卡片列表布局，使其完全自适应WordPress后台页面宽度
- 消除右侧空白区域，最大化利用可用空间
- 改进响应式布局，确保在各种屏幕尺寸下都能完整显示

### 5.2.2
- 优化管理界面布局，缓存状态和使用说明并排显示
- 添加缓存卡片列表编辑功能
- 实现响应式表格，自适应各种屏幕尺寸
- 改进用户界面和交互体验

### 5.2.1
- 添加缓存卡片列表管理功能
- 优化后台管理界面
- 更新文档和使用说明

### 5.2.0
- 添加Opcache和Memcached多级缓存支持
- 优化缓存读取和写入逻辑
- 添加缓存状态查看功能

### 5.1.1
- 修复方法可见性问题
- 提高插件稳定性

### 5.1.0
- 全面安全增强
- 优化错误处理和日志记录
- 改进图片处理逻辑

### 1.0.0
- 初始版本发布

## 技术支持

如有任何问题或需要技术支持，请联系插件开发者。

- 插件作者：17376592083
- 作者网站：https://www.saita.top
- 支持邮箱：chenghoufeng@saiita.top

